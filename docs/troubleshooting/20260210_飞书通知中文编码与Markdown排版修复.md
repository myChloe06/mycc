# 飞书通知中文编码与 Markdown 排版修复

**日期**：2026-02-10
**状态**：✅ 已解决
**标签**：`#飞书通知` `#中文编码` `#Markdown` `#跨平台`

---

## 问题描述

### 现象
飞书通知发送后，中文可以正常显示，但 **Markdown 排版完全失效**：
- 所有内容挤在一起，没有换行
- 粗体（`**text**`）和斜体（`*text*`）可以正常显示
- 列表、代码块、空行等需要换行的格式都无法生效

### 用户反馈
> "排版还是不对，这一整段都是在同一段里，也没有换行，有加粗和斜体但是没有换行"

收到效果：
```
状态测试：这是粗体文字这是斜体文字列表测试：- 第一项- 第二项- 第三项代码测试：`这是行内代码`混合测试：这是普通文字，加粗强调，然后斜体。空行测试：上面有空行，这段话应该在新的一行。
```

预期效果：
```
状态测试：这是粗体文字

这是斜体文字

列表测试：
- 第一项
- 第二项
- 第三项

代码测试：`这是行内代码`

空行测试：

上面有空行
这段话应该在新的一行。
```

---

## 问题排查过程

### 1. 确认 API 格式正确
首先检查飞书 API 返回的状态码：
```bash
{"StatusCode":0,"StatusMessage":"success","code":0,"data":{},"msg":"success"}
```
✅ API 调用成功，说明不是 API 问题

### 2. 检查 JSON 文件内容
生成测试 JSON 文件，检查换行符是否正确：
```json
{
  "content": "**测试**：\n第一行\n\n第二行"
}
```
✅ JSON 中的 `\n` 换行符是正确的

### 3. 测试直接用 Node.js 发送
```bash
node -e "
const data = {
  msg_type: 'interactive',
  card: {
    elements: [{
      tag: 'div',
      text: { content: '**测试**：\n第一行\n\n第二行', tag: 'lark_md' }
    }]
  }
};
fs.writeFileSync('test.json', JSON.stringify(data, null, 2), 'utf-8');
"
curl -X POST "$WEBHOOK" -d @test.json
```
✅ 直接用 Node.js 生成 JSON 并发送，**排版正常**

### 4. 定位问题根源
对比 bash 脚本版本和直接 Node.js 版本，发现：
- **直接 Node.js**：换行符正确传递，排版正常
- **bash 脚本调用 Node.js**：换行符在参数传递过程中被吃掉

**结论**：问题出在 **bash 脚本在传递参数给 Node.js 时，换行符（`\n`）被转义或吞掉了**

---

## 解决方案

### 最终方案：使用 Node.js 直接处理

#### send.js（最终版本）
```javascript
#!/usr/bin/env node
/**
 * 飞书通知脚本 - 直接生成并发送
 * 用法: node send.js "标题" "内容" [颜色]
 */

const [,, title, content, color = 'blue'] = process.argv;

// 处理换行符：将输入的 \n 转换为真正的换行符
const processedContent = content.replace(/\\n/g, '\n');

const card = {
  msg_type: 'interactive',
  card: {
    header: {
      title: { content: `📌 ${title}`, tag: 'plain_text' },
      template: color
    },
    elements: [
      {
        tag: 'div',
        text: { content: processedContent, tag: 'lark_md' }
      },
      {
        tag: 'note',
        elements: [{
          tag: 'plain_text',
          content: `⏰ ${new Date().toLocaleString('zh-CN')}`
        }]
      }
    ]
  }
};

fetch(webhook, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json; charset=utf-8' },
  body: JSON.stringify(card)
})
  .then(res => res.json())
  .then(data => {
    if (data.code === 0) {
      console.log('✅ 发送成功');
    }
  });
```

**关键代码**：
```javascript
const processedContent = content.replace(/\\n/g, '\n');
```

---

## 使用方式

### Windows PowerShell（推荐）
```powershell
# 方式 1：使用 PowerShell 换行符 `n
node send.js "标题" "第一行`n`n第二行" green

# 方式 2：使用 \n（Node.js 会自动转换）
node send.js "标题" "第一行\n\n第二行" green
```

### Linux/macOS / Git Bash
```bash
# 使用 \n
node send.js "标题" "第一行\n\n第二行" green
```

### Markdown 格式示例
```javascript
// 粗体
**这是粗体**

// 斜体
*这是斜体*

// 列表
**任务列表**：
- 任务 1
- 任务 2
- 任务 3

// 空行
第一段

第二段（中间有空行）
```

---

## 技术要点

### 1. 换行符处理
- **输入**：用户输入 `\n`（字符串）
- **处理**：`content.replace(/\\n/g, '\n')` 转换为真正的换行符
- **输出**：JSON 中包含 `\n`，飞书 API 解析后显示为换行

### 2. 为什么 bash 脚本不行？
在 Git Bash 环境下：
```bash
CONTENT="$2"  # bash 变量
node -e "console.log('$CONTENT')"  # 传递给 Node.js
```
问题：
- bash 传递参数时，`\n` 会被解释为两个字符（反斜杠 + n）
- 即使使用 `sed 's/\\n/\n/g'`，在跨平台场景下也不稳定
- Windows 路径、引号转义等问题进一步复杂化

### 3. 为什么 Node.js 直接处理可以？
```javascript
const processedContent = content.replace(/\\n/g, '\n');
```
优势：
- Node.js 字符串处理原生支持 Unicode 和 UTF-8
- 正则表达式 `/\n/g` 正确匹配换行符
- 避免 shell 层的转义和参数传递问题

---

## 经验总结

### ✅ 做对的事情
1. **从简单到复杂**：先用 Node.js 直接测试，确认 API 本身没问题
2. **逐步排查**：JSON → curl → Node.js → bash，逐层定位问题
3. **选择正确工具**：跨平台场景下，Node.js 比 bash 更可靠

### ❌ 踩过的坑
1. **过度设计**：一开始想用 bash + curl + JSON 文件方式，实际上增加了复杂度
2. **忽略环境差异**：Git Bash 在 Windows 下的行为与 Linux/macOS 不同
3. **未充分测试**：bash 脚本没有在目标环境（Git Bash）下充分测试

### 📚 核心原则
1. **KISS 原则**：Keep It Simple, Stupid. 能用 Node.js 直接处理，就不要加 bash 包装
2. **跨平台优先**：在 Windows/Linux/macOS 都要能正常工作
3. **UTF-8 优先**：中文环境下，确保所有环节都是 UTF-8 编码

---

## 相关文件

- `.claude/skills/tell-me/send.js` - 飞书通知脚本（Node.js 版本）
- `.claude/skills/tell-me/send.sh` - 飞书通知脚本（Bash 版本，已废弃）
- `.claude/skills/tell-me/SKILL.md` - tell-me skill 配置

---

## 参考资源

### 飞书官方文档
- [飞书机器人 - 自定义机器人](https://open.feishu.cn/document/ukTMukTMukTM/uUTNz4SN1MjL1UzM)
- [飞书卡片消息格式](https://open.feishu.cn/document/ukTMukTMukTM/uEjNwUjLxYDM14SM2ATN)

### Markdown 规范
- [Lark Markdown 语法](https://open.feishu.cn/document/ukTMukTMukTM/uYjNwUjL2YDM14iN2ATN)
- 支持：**粗体**、*斜体*、`代码`、- 列表、\n 换行

---

## 更新日志

| 日期 | 版本 | 说明 |
|------|------|------|
| 2026-02-10 | v1.0 | 初始版本，记录中文编码与 Markdown 排版问题及解决方案 |

---

**文档维护**：cc
**最后更新**：2026-02-10
